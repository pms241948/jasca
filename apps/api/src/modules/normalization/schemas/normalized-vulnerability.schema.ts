// Normalized Vulnerability Schema
// This defines the internal standard schema for vulnerability data
// to ensure consistency across different Trivy versions and scanner outputs

export interface NormalizedVulnerability {
    // Core identification
    id: string;
    cveId: string;

    // Descriptive information
    title: string;
    description: string;

    // Severity information
    severity: 'CRITICAL' | 'HIGH' | 'MEDIUM' | 'LOW' | 'UNKNOWN';
    cvssV2Score?: number;
    cvssV2Vector?: string;
    cvssV3Score?: number;
    cvssV3Vector?: string;

    // CWE and references
    cweIds: string[];
    references: string[];

    // Package information
    packageInfo: {
        name: string;
        version: string;
        fixedVersion?: string;
        ecosystem: PackageEcosystem;
        path?: string;
    };

    // Layer information (for container images)
    layerInfo?: {
        digest?: string;
        diffId?: string;
        createdBy?: string;
    };

    // Temporal information
    publishedAt?: Date;
    lastModifiedAt?: Date;

    // Additional metadata
    metadata: {
        datasources: string[];
        vendorUpdates?: Record<string, Date>;
        exploitAvailable?: boolean;
        patchAvailable?: boolean;
    };
}

export type PackageEcosystem =
    | 'npm'
    | 'pip'
    | 'maven'
    | 'gradle'
    | 'nuget'
    | 'go'
    | 'cargo'
    | 'composer'
    | 'gem'
    | 'alpine'
    | 'debian'
    | 'redhat'
    | 'ubuntu'
    | 'centos'
    | 'amazon-linux'
    | 'oracle-linux'
    | 'photon'
    | 'suse'
    | 'other';

export interface NormalizedScanResult {
    // Schema version for our internal format
    schemaVersion: string;

    // Scanner information
    scanner: {
        name: string;
        version: string;
        originalSchemaVersion?: string;
    };

    // Artifact information
    artifact: {
        name: string;
        type: ArtifactType;
        digest?: string;
        imageId?: string;
    };

    // Scan metadata
    scanMetadata: {
        scannedAt: Date;
        duration?: number;
        config?: Record<string, any>;
    };

    // Normalized vulnerabilities
    vulnerabilities: NormalizedVulnerability[];

    // Summary
    summary: {
        total: number;
        bySeverity: Record<string, number>;
        byPackageType: Record<string, number>;
        fixable: number;
    };
}

export type ArtifactType =
    | 'container_image'
    | 'filesystem'
    | 'repository'
    | 'vm_image'
    | 'rootfs'
    | 'sbom'
    | 'other';

// Schema version mapping for Trivy
export interface TrivySchemaMapping {
    schemaVersion: string;
    supportedVersions: string[];
    fieldMappings: Record<string, string>;
    transformations: Record<string, (value: any) => any>;
}

// Version registry for schema compatibility
export const CURRENT_SCHEMA_VERSION = '1.0.0';

export const TRIVY_SCHEMA_MAPPINGS: TrivySchemaMapping[] = [
    {
        schemaVersion: '2',
        supportedVersions: ['0.40.0', '0.41.0', '0.42.0', '0.43.0', '0.44.0', '0.45.0', '0.46.0', '0.47.0', '0.48.0', '0.49.0', '0.50.0', '0.51.0', '0.52.0', '0.53.0', '0.54.0', '0.55.0', '0.56.0', '0.57.0', '0.58.0'],
        fieldMappings: {
            'VulnerabilityID': 'cveId',
            'PkgName': 'packageInfo.name',
            'InstalledVersion': 'packageInfo.version',
            'FixedVersion': 'packageInfo.fixedVersion',
            'Title': 'title',
            'Description': 'description',
            'Severity': 'severity',
            'References': 'references',
            'CweIDs': 'cweIds',
            'PublishedDate': 'publishedAt',
            'LastModifiedDate': 'lastModifiedAt',
        },
        transformations: {},
    },
    {
        schemaVersion: '1',
        supportedVersions: ['0.18.0', '0.19.0', '0.20.0', '0.21.0', '0.22.0', '0.23.0', '0.24.0', '0.25.0', '0.26.0', '0.27.0', '0.28.0', '0.29.0', '0.30.0', '0.31.0', '0.32.0', '0.33.0', '0.34.0', '0.35.0', '0.36.0', '0.37.0', '0.38.0', '0.39.0'],
        fieldMappings: {
            'VulnerabilityID': 'cveId',
            'PkgName': 'packageInfo.name',
            'InstalledVersion': 'packageInfo.version',
            'FixedVersion': 'packageInfo.fixedVersion',
            'Title': 'title',
            'Description': 'description',
            'Severity': 'severity',
            'References': 'references',
            'CweIDs': 'cweIds',
        },
        transformations: {},
    },
];
